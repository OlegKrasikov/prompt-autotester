// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]
  scenarios     Scenario[]
  scenarioSuites ScenarioSuite[]
  prompts       Prompt[]
  apiKeys       UserApiKey[]
  variables     Variable[]
  profile       UserProfile?
  memberships   OrganizationMember[]
  organizationsCreated Organization[] @relation("OrgCreator")
  invitationsSent      OrganizationInvitation[] @relation("OrgInviteInviter")
  invitationsAccepted  OrganizationInvitation[] @relation("OrgInviteAccepter")

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Scenario {
  id           String                 @id @default(uuid())
  userId       String                 @map("user_id")
  orgId        String                 @map("org_id")
  name         String
  description  String?
  locale       String                 @default("en")
  seed         Int?
  maxTurns     Int?                   @map("max_turns")
  status       ScenarioStatus         @default(DRAFT)
  version      Int                    @default(1)
  tags         String[]               @default([])
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")
  
  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization?          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  turns        ScenarioTurn[]
  expectations ScenarioExpectation[]
  suiteItems   ScenarioSuiteItem[]
  versions     ScenarioVersion[]

  @@map("scenario")
  @@index([userId, status, updatedAt], map: "idx_scenario_user_status_updated")
  @@index([orgId, status, updatedAt], map: "idx_scenario_org_status_updated")
  @@unique([orgId, name], name: "idx_scenario_org_name_unique")
}

model ScenarioTurn {
  id          BigInt               @id @default(autoincrement())
  scenarioId  String               @map("scenario_id")
  orderIndex  Int                  @map("order_index")
  turnType    ScenarioTurnType     @map("turn_type")
  userText    String?              @map("user_text")
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  scenario     Scenario              @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  expectations ScenarioExpectation[]

  @@unique([scenarioId, orderIndex], name: "idx_turn_unique_order")
  @@map("scenario_turn")
}

model ScenarioExpectation {
  id              BigInt              @id @default(autoincrement())
  scenarioId      String              @map("scenario_id")
  turnId          BigInt              @map("turn_id")
  expectationKey  String              @map("expectation_key")
  expectationType ExpectationType     @map("expectation_type")
  argsJson        Json                @default("{}") @map("args_json")
  weight          Int?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  scenario Scenario     @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  turn     ScenarioTurn @relation(fields: [turnId], references: [id], onDelete: Cascade)

  @@map("scenario_expectation")
}

model ScenarioVersion {
  versionId     BigInt   @id @default(autoincrement()) @map("version_id")
  scenarioId    String   @map("scenario_id")
  versionNumber Int      @map("version_number")
  payload       Json
  createdAt     DateTime @default(now()) @map("created_at")
  createdBy     String?  @map("created_by")

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, versionNumber], name: "idx_scenario_version_unique")
  @@map("scenario_version")
}

model ScenarioSuite {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  orgId       String   @map("org_id")
  name        String
  description String?
  tags        String[] @default([])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)
  items ScenarioSuiteItem[]

  @@map("scenario_suite")
}

model ScenarioSuiteItem {
  suiteId     String @map("suite_id")
  scenarioId  String @map("scenario_id")
  orderIndex  Int    @map("order_index")

  suite    ScenarioSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  scenario Scenario      @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@id([suiteId, scenarioId])
  @@map("scenario_suite_item")
}

enum ScenarioStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@map("scenario_status")
}

enum ScenarioTurnType {
  USER
  EXPECT

  @@map("scenario_turn_type")
}

enum ExpectationType {
  MUST_CONTAIN
  MUST_CONTAIN_ANY
  MUST_NOT_CONTAIN
  REGEX
  SEMANTIC_ASSERT

  @@map("expectation_type")
}

model UserApiKey {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  orgId     String   @map("org_id")
  provider  String   // 'openai', 'anthropic', etc.
  keyName   String   @map("key_name") // Display name for the key
  encryptedKey String @map("encrypted_key") // Encrypted API key
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, provider], name: "idx_org_provider_unique")
  @@map("user_api_key")
  @@index([userId, isActive, provider], map: "idx_userapi_user_active_provider")
  @@index([orgId, isActive, provider], map: "idx_userapi_org_active_provider")
}

model Prompt {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  orgId       String       @map("org_id")
  name        String
  description String?
  content     String       @db.Text
  status      PromptStatus @default(DRAFT)
  tags        String[]     @default([])
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("prompt")
  @@index([userId, status, updatedAt], map: "idx_prompt_user_status_updated")
  @@index([orgId, status, updatedAt], map: "idx_prompt_org_status_updated")
  @@unique([orgId, name], name: "idx_prompt_org_name_unique")
}

enum PromptStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@map("prompt_status")
}

model Variable {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  orgId       String   @map("org_id")
  key         String
  value       String   @db.Text
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, key], name: "idx_org_variable_unique")
  @@map("variable")
  @@index([userId, updatedAt], map: "idx_variable_user_updated")
  @@index([orgId, updatedAt], map: "idx_variable_org_updated")
}

// Multi-org models

model Organization {
  id               String                 @id @default(uuid())
  name             String
  slug             String                 @unique
  createdByUserId  String                 @map("created_by_user_id")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")

  creator          User                   @relation("OrgCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  members          OrganizationMember[]
  invitations      OrganizationInvitation[]
  lastActiveForProfiles UserProfile[]      @relation("LastActiveOrg")
  scenarios        Scenario[]
  prompts          Prompt[]
  variables        Variable[]
  scenarioSuites   ScenarioSuite[]
  apiKeys          UserApiKey[]

  @@map("organization")
}

model OrganizationMember {
  orgId     String   @map("org_id")
  userId    String   @map("user_id")
  role      OrgRole  @default(VIEWER)
  status    MemberStatus @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@map("organization_member")
  @@index([userId, role, status], map: "idx_member_user_role_status")
}

model OrganizationInvitation {
  id              String      @id @default(uuid())
  orgId           String      @map("org_id")
  email           String
  role            OrgRole     @default(VIEWER)
  token           String      @unique
  expiresAt       DateTime    @map("expires_at")
  invitedByUserId String      @map("invited_by_user_id")
  acceptedByUserId String?    @map("accepted_by_user_id")
  status          InviteStatus @default(PENDING)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("OrgInviteInviter", fields: [invitedByUserId], references: [id])
  acceptedBy   User?        @relation("OrgInviteAccepter", fields: [acceptedByUserId], references: [id])

  @@map("organization_invitation")
  @@index([orgId, email, status], map: "idx_invite_org_email_status")
}

model UserProfile {
  userId          String   @id @map("user_id")
  lastActiveOrgId String?  @map("last_active_org_id")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastActiveOrg   Organization? @relation("LastActiveOrg", fields: [lastActiveOrgId], references: [id])

  @@map("user_profile")
}

enum OrgRole {
  ADMIN
  EDITOR
  VIEWER

  @@map("org_role")
}

enum MemberStatus {
  ACTIVE
  INVITED
  REMOVED

  @@map("member_status")
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED

  @@map("invite_status")
}
